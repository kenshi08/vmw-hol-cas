formatVersion: 1
inputs: {}
resources:
  LB:
    type: Cloud.LoadBalancer
    properties:
      name: lb
      routes:
        - instancePort: 80
          instanceProtocol: http
          port: 80
          protocol: http
      network: '${resource.Network.name}'
      instances:
        - '${resource.Machine.id}'
      internetFacing: true
  Machine:
    type: Cloud.Machine
    createBeforeDelete: true
    properties:
      image: ubuntu
      flavor: small
      constraints:
        - tag: 'platform:aws'
      cloudConfig: |
        packages:
          - apache2
        runcmd:
          - ufw allow 'Apache Full'
          - git clone https://grantorchard:J2WsLWJJ^.4+j4J8Nh3+2hhMrqj9D@github.com/romant/dingo
          - cp -r /dingo/* /var/www/html/
        users:
          - name: grant
            ssh-authorized-keys:
             - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC8rqxon4hRyV5cLNZczuJTe8dsZ33hpWHDU993r4iiY3t9bXqfmIHlIZ7dTL93nlvsgzVdOYMVGMOHMg/a1ZK0VRoKTS5BBhBGJejjDUfWRAtedZbM9JE5HHpks+L+nf8cOM14Os+Q3BV+z4MjYfIK5ZbV0IvUaY0kscQcE8cZoOTC2hHu/MPDneKJxG+HRQJfvqvnWz69/EXyi9iqtmOn0Xy9905qtbPNlDs1c4qF+zZ1qQCkMYP0Z4AVvLaPEJZlPmDnGqz5s1vVb130aXe1A11eq4RwgvZRxXW8i88pKqCGPuLRh7anqvSI15SLpA2KWvu7wD5CvhTisc/6TfVf
            sudo: ['ALL=(ALL) NOPASSWD:ALL']
            groups: sudo
            shell: /bin/bash
      networks:
        - name: '${resource.Network.name}'
  Network:
    type: Cloud.Network
    properties:
      name: web
      networkType: existing